name: Build Android APK

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  # 允许手动触发此工作流
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # 在支持的情况下，可以设置为 macos-latest 以获取原生性能
    # runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin' # 可选：'zulu', 'corretto' 等
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Grant execute permission for Gradle Wrapper
      # 确保项目中的 gradlew 脚本有执行权限
      run: chmod +x ./gradlew

    - name: Cache Gradle dependencies
      # 缓存 Gradle 依赖，以显著加快后续构建速度
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Build with Gradle (Debug)
      # 构建 Debug 版本的 APK
      run: ./gradlew assembleDebug

    - name: Run tests with Gradle
      # 运行单元测试
      run: ./gradlew test

    - name: Upload APK artifact
      # 上传生成的 APK 文件作为工作流工件
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-apk
        path: app/build/outputs/apk/debug/app-debug.apk
        # 如果您有多个模块，路径可能需要调整，例如：
        # path: **/outputs/apk/**/*.apk
        retention-days: 7
